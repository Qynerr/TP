<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Para Takip — Modern</title>
  <meta name="description" content="Modern, icon destekli para takip uygulaması (localStorage)." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>₺</text></svg>" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <!-- Firebase App -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <!-- Firebase Auth -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <!-- Firebase Firestore -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <style>
    :root{
      --bg-1:#f8fafc; --bg-2:#eef2ff; --card:#ffffff; --muted:#6b7280; --accent:#7c3aed; --accent-2:#06b6d4;
      --income:#10b981; --expense:#ef4444; --glass: rgba(2,6,23,0.04);
      --shadow: 0 10px 30px rgba(2,6,23,0.08);
      --glass-2: rgba(79,70,229,0.06);
      /* frame colors */
      --frame: rgba(15,23,42,0.06);
      --frame-strong: rgba(124,58,237,0.10);
      --frame-radius: 14px;
    }
    /* Dark theme variables (single-color icons will respect these) */
    :root[data-theme='dark'], body[data-theme='dark']{
      --bg-1: #071029;
      --bg-2: #041423;
      --card: #071829;
      --muted: #94a3b8;
      --accent: #7c3aed;
      --accent-2: #06b6d4;
      --income: #34d399; /* slightly brighter for dark */
      --expense: #fb7185;
      --glass: rgba(255,255,255,0.04);
      --glass-2: rgba(124,58,237,0.06);
      --shadow: 0 10px 30px rgba(2,6,23,0.6);
      color: #e6eef8;
      --frame: rgba(255,255,255,0.04);
      --frame-strong: rgba(124,58,237,0.14);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));color:#0b1220}
  .wrap{max-width:1100px;margin:28px auto;padding:18px;border:1px solid var(--frame);border-radius:var(--frame-radius);box-shadow: var(--shadow), 0 6px 20px var(--frame-strong);transition:box-shadow .18s ease,transform .12s ease}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{font-weight:800;font-size:1.25rem;display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44;border-radius:12px;background:linear-gradient(135deg,var(--accent),#4f46e5);display:flex;align-items:center;justify-content:center;color:white;font-weight:800}
    .layout{display:grid;grid-template-columns:320px 1fr;gap:18px;margin-top:18px}
  .panel{background:var(--card);padding:14px;border-radius:12px;box-shadow:var(--shadow);border:1px solid var(--frame);transition:box-shadow .12s ease,transform .12s ease}
  .panel:hover{box-shadow: 0 16px 36px rgba(2,6,23,0.12)}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(15,23,42,0.04);background:transparent;color:inherit}
    input:focus,select:focus,textarea:focus{outline:2px solid rgba(124,58,237,0.12);outline-offset:2px}
    .row{display:flex;gap:8px}
    .btn{background:linear-gradient(90deg,var(--accent),#4f46e5);color:white;padding:10px 12px;border-radius:10px;border:0;cursor:pointer;box-shadow:0 6px 18px rgba(79,70,229,0.12)}
    .secondary{background:transparent;border:1px solid rgba(15,23,42,0.04);color:var(--muted);padding:8px 10px;border-radius:10px}
    .auth-form{max-width:400px;margin:40px auto;text-align:center}
    .google-btn{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;background:#fff;color:#333;border:1px solid #ddd;margin:10px 0}
    .auth-form input{margin-bottom:10px}
    .user-info{display:flex;align-items:center;gap:8px}
    .user-avatar{width:32px;height:32px;border-radius:50%;object-fit:cover}
    .auth-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center}
    .auth-modal .panel{width:400px;margin:20px}
    .summary{display:flex;gap:12px;margin-bottom:12px}
    .card{flex:1;padding:16px;border-radius:12px;background:linear-gradient(180deg,rgba(79,70,229,0.02),transparent);}
    .big{font-size:1.4rem;font-weight:800}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;text-align:left;border-bottom:1px solid rgba(15,23,42,0.03);font-size:14px}
    td.amount{font-weight:800}
    .income{color:var(--income)}.expense{color:var(--expense)}
    .small{font-size:12px;color:var(--muted)}
    .controls{display:flex;gap:8px;align-items:center}
    canvas{width:100%;height:140px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent)}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{padding:6px 10px;border-radius:999px;background:rgba(15,23,42,0.03);font-size:13px;cursor:pointer}
    .chip.active{background:linear-gradient(90deg,var(--accent-2),#7dd3fc);color:#03202a}
    .row-anim{animation:popIn .26s ease}
    @keyframes popIn{from{opacity:0;transform:translateY(6px) scale(.99)}to{opacity:1;transform:translateY(0) scale(1)}}
    @media (max-width:880px){ .layout{grid-template-columns:1fr} .panel{padding:12px} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div style="display:flex;align-items:center;gap:12px">
        <div class="brand"><div class="logo">₺</div>Para Takip</div>
        <button id="themeToggle" class="secondary" title="Tema değiştir" style="display:flex;align-items:center;gap:8px"><i class="fas fa-moon"></i></button>
      </div>
      <div class="controls" style="display:flex;align-items:center;gap:12px">
        <div id="userInfo" class="user-info" style="display:none">
          <img id="userAvatar" class="user-avatar" src="" alt="">
          <span id="userName"></span>
          <button id="logoutBtn" class="secondary">Çıkış Yap</button>
        </div>
        <button id="loginBtn" class="btn">Giriş Yap</button>
      </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="auth-modal" style="display:none">
      <div class="panel auth-form">
        <h2 id="authTitle">Giriş Yap</h2>
        <button id="googleLoginBtn" class="btn google-btn">
          <img src="https://www.google.com/favicon.ico" width="20" height="20">
          Google ile Devam Et
        </button>
        <div style="text-align:center;margin:10px 0;color:var(--muted)">veya</div>
        <form id="authForm">
          <input type="email" id="emailInput" placeholder="E-posta" required>
          <input type="password" id="passwordInput" placeholder="Şifre" required>
          <button type="submit" class="btn" style="width:100%">Giriş Yap</button>
        </form>
        <p style="margin-top:20px">
          <a href="#" id="toggleAuthMode" style="color:var(--accent)">Hesabınız yok mu? Kayıt olun</a>
        </p>
        <button id="closeAuthModal" class="secondary" style="position:absolute;right:10px;top:10px">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>

    <div class="layout">
      <aside class="panel">
        <div class="small">Yeni İşlem</div>
        <div style="margin-top:8px">
          <label>Açıklama</label>
          <input id="desc" placeholder="Örn: Market alışverişi" />

          <div style="display:flex;gap:8px;margin-top:8px">
            <div style="flex:1">
              <label>Tutar</label>
              <input id="amount" type="number" step="0.01" placeholder="0.00" />
            </div>
            <div style="width:120px">
              <label>Tür</label>
              <select id="type"><option value="expense">Gider (-)</option><option value="income">Gelir (+)</option></select>
            </div>
          </div>

          <label style="margin-top:8px">Kategori</label>
          <select id="category"></select>

          <label style="margin-top:8px">Tarih</label>
          <input id="date" type="date" />

          <div style="display:flex;gap:8px;margin-top:12px">
            <button id="addBtn" class="btn">Ekle</button>
            <button id="clearBtn" class="secondary">Temizle</button>
          </div>

          <div class="small" style="margin-top:12px">Kategoriler</div>
          <div id="chips" class="chips"></div>

          <hr style="margin:12px 0;border:none;border-top:1px solid rgba(15,23,42,0.05)" />

          <div class="small">Veri İşlemleri</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="exportBtn" class="secondary">Dışa Aktar</button>
            <button id="importBtn" class="secondary">İçe Aktar</button>
            <input id="importFile" type="file" accept="application/json" style="display:none" />
          </div>
        </div>
      </aside>

      <main>
        <div class="panel fade">
          <div class="summary">
            <div class="card">
              <div class="small">Toplam Bakiye</div>
              <div id="balance" class="big">0.00 ₺</div>
            </div>
            <div class="card">
              <div class="small">Toplam Gelir</div>
              <div id="totalIncome" class="big income">0.00 ₺</div>
            </div>
            <div class="card">
              <div class="small">Toplam Gider</div>
              <div id="totalExpense" class="big expense">0.00 ₺</div>
            </div>
          </div>
          <div style="margin-top:16px">
            <canvas id="chart"></canvas>
          </div>

          <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
            <div class="controls">
              <label class="small">Ara (kategori veya açıklama):</label>
              <input id="q" placeholder="Ara..." style="width:220px" />
            </div>
            <div style="flex:1"></div>
            <div class="small">Toplam işlem: <span id="count">0</span></div>
          </div>



          <div class="panel" style="margin-top: 12px">
            <table id="txTable">
              <thead><tr><th>Tarih</th><th>Açıklama</th><th>Kategori</th><th>Miktar</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBB1Cr-7gKiykTQ28z1vB8Re6nnWte-YZQ",
      authDomain: "para-takip-ea6b9.firebaseapp.com",
      databaseURL: "https://para-takip-ea6b9-default-rtdb.firebaseio.com",
      projectId: "para-takip-ea6b9",
      storageBucket: "para-takip-ea6b9.firebasestorage.app",
      messagingSenderId: "14253422937",
      appId: "1:14253422937:web:7b142c469146e4e92db448",
      measurementId: "G-4SB4TZW3YW"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    let currentUser = null;

    // Auth elements
    const authElements = {
      loginBtn: document.getElementById('loginBtn'),
      logoutBtn: document.getElementById('logoutBtn'),
      authModal: document.getElementById('authModal'),
      authForm: document.getElementById('authForm'),
      authTitle: document.getElementById('authTitle'),
      emailInput: document.getElementById('emailInput'),
      passwordInput: document.getElementById('passwordInput'),
      googleLoginBtn: document.getElementById('googleLoginBtn'),
      toggleAuthMode: document.getElementById('toggleAuthMode'),
      closeAuthModal: document.getElementById('closeAuthModal'),
      userInfo: document.getElementById('userInfo'),
      userAvatar: document.getElementById('userAvatar'),
      userName: document.getElementById('userName')
    };

    let isLoginMode = true;

    // Auth state observer
    auth.onAuthStateChanged((user) => {
      currentUser = user;
      if (user) {
        // User is signed in
        authElements.loginBtn.style.display = 'none';
        authElements.userInfo.style.display = 'flex';
        authElements.userAvatar.src = user.photoURL || 'https://www.gravatar.com/avatar/?d=mp';
        authElements.userName.textContent = user.displayName || user.email;
        authElements.authModal.style.display = 'none';
        loadUserTransactions();
      } else {
        // User is signed out
        authElements.loginBtn.style.display = 'block';
        authElements.userInfo.style.display = 'none';
        loadLocalTransactions();
      }
    });

    // Show auth modal
    authElements.loginBtn.addEventListener('click', () => {
      authElements.authModal.style.display = 'flex';
    });

    // Close auth modal
    authElements.closeAuthModal.addEventListener('click', () => {
      authElements.authModal.style.display = 'none';
    });

    // Toggle between login and register
    authElements.toggleAuthMode.addEventListener('click', (e) => {
      e.preventDefault();
      isLoginMode = !isLoginMode;
      authElements.authTitle.textContent = isLoginMode ? 'Giriş Yap' : 'Kayıt Ol';
      authElements.authForm.querySelector('button[type="submit"]').textContent = 
        isLoginMode ? 'Giriş Yap' : 'Kayıt Ol';
      authElements.toggleAuthMode.textContent = 
        isLoginMode ? 'Hesabınız yok mu? Kayıt olun' : 'Hesabınız var mı? Giriş yapın';
    });

    // Handle email/password auth
    authElements.authForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = authElements.emailInput.value;
      const password = authElements.passwordInput.value;

      try {
        if (isLoginMode) {
          await auth.signInWithEmailAndPassword(email, password);
        } else {
          await auth.createUserWithEmailAndPassword(email, password);
        }
      } catch (error) {
        alert(error.message);
      }
    });

    // Google sign in
    authElements.googleLoginBtn.addEventListener('click', async () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        await auth.signInWithPopup(provider);
      } catch (error) {
        alert(error.message);
      }
    });

    // Sign out
    authElements.logoutBtn.addEventListener('click', async () => {
      try {
        await auth.signOut();
      } catch (error) {
        alert(error.message);
      }
    });

    // Load transactions based on auth state
    async function loadUserTransactions() {
      try {
        const snapshot = await db.collection('transactions')
          .where('userId', '==', currentUser.uid)
          .get();
        tx = snapshot.docs.map(doc => ({...doc.data(), id: doc.id}));
        render();
      } catch (error) {
        console.error('Error loading transactions:', error);
        tx = [];
        render();
      }
    }

    function loadLocalTransactions() {
      try {
        tx = JSON.parse(localStorage.getItem(KEY) || '[]');
        render();
      } catch (e) {
        tx = [];
        render();
      }
    }

    // Save transaction
    async function saveTransaction(transaction) {
      if (currentUser) {
        try {
          const docRef = await db.collection('transactions').add({
            ...transaction,
            userId: currentUser.uid
          });
          return {...transaction, id: docRef.id};
        } catch (error) {
          console.error('Error saving transaction:', error);
          return null;
        }
      } else {
        // Fallback to localStorage
        return transaction;
      }
    }

    // Modernized finance app with emojis and edit support
    const KEY = 'pt_transactions_v1';
    let tx = []; let editId = null;

    // Web Audio API ile bozuk para sesi ve toast mesajı
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    function playCoinSound(type) {
      // Coin sound: two quick oscillators for 'ching' effect
      const now = audioContext.currentTime;
      const gain = audioContext.createGain();
      gain.connect(audioContext.destination);
      gain.gain.setValueAtTime(0.18, now);
      gain.gain.linearRampToValueAtTime(0.01, now + 0.32);

      // First ping
      const osc1 = audioContext.createOscillator();
      osc1.type = 'triangle';
      osc1.frequency.setValueAtTime(type === 'income' ? 1200 : 700, now);
      osc1.connect(gain);
      osc1.start(now);
      osc1.stop(now + 0.13);

      // Second ping (higher for income, lower for expense)
      const osc2 = audioContext.createOscillator();
      osc2.type = 'triangle';
      osc2.frequency.setValueAtTime(type === 'income' ? 1800 : 500, now + 0.09);
      osc2.connect(gain);
      osc2.start(now + 0.09);
      osc2.stop(now + 0.22);
    }

    // Toast mesajı
    function showToast(msg, type) {
      let toast = document.getElementById('toastMsg');
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toastMsg';
        toast.style.position = 'fixed';
        toast.style.left = '50%';
        toast.style.bottom = '36px';
        toast.style.transform = 'translateX(-50%)';
        toast.style.zIndex = 9999;
        toast.style.padding = '16px 28px';
        toast.style.borderRadius = '16px';
        toast.style.fontWeight = 'bold';
        toast.style.fontSize = '1.1rem';
        toast.style.boxShadow = '0 6px 32px rgba(0,0,0,0.18)';
        toast.style.transition = 'opacity .3s, bottom .3s';
        document.body.appendChild(toast);
      }
      toast.textContent = msg;
      toast.style.background = type === 'income' ? 'linear-gradient(90deg,#10b981,#34d399)' : 'linear-gradient(90deg,#ef4444,#fb7185)';
      toast.style.color = '#fff';
      toast.style.opacity = '1';
      toast.style.bottom = '36px';
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.bottom = '16px';
      }, 1400);
    }

    // Theme handling
    const THEME_KEY = 'pt_theme_v1';
    function applyTheme(theme){
      document.documentElement.setAttribute('data-theme', theme);
      document.body.setAttribute('data-theme', theme);
      const btn = document.getElementById('themeToggle');
      if(btn) btn.innerHTML = theme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
    }
    function loadTheme(){
      const t = localStorage.getItem(THEME_KEY) || 'light';
      applyTheme(t);
    }
    function toggleTheme(){
      const cur = document.documentElement.getAttribute('data-theme') || 'light';
      const next = cur === 'dark' ? 'light' : 'dark';
      localStorage.setItem(THEME_KEY, next);
      applyTheme(next);
      // redraw charts to pick up new colors
      updateAllCharts();
    }

    const CATEGORIES = [
      {name: 'Genel', icon: 'fas fa-box'},
      {name: 'Yiyecek', icon: 'fas fa-utensils'},
      {name: 'Ulaşım', icon: 'fas fa-bus'},
      {name: 'Kira', icon: 'fas fa-home'},
      {name: 'Gelir', icon: 'fas fa-briefcase'},
      {name: 'Market', icon: 'fas fa-shopping-cart'},
      {name: 'Faturalar', icon: 'fas fa-file-invoice'},
      {name: 'Diğer', icon: 'fas fa-tag'}
    ];

    function uid(){return 't_'+Date.now()+'_'+Math.random().toString(36).slice(2,7)}
    function load(){ try{ tx = JSON.parse(localStorage.getItem(KEY) || '[]') }catch(e){ tx=[] } }
    function save(){ localStorage.setItem(KEY, JSON.stringify(tx)) }

    // elements
    const els = {
      desc: document.getElementById('desc'), amount: document.getElementById('amount'), type: document.getElementById('type'), category: document.getElementById('category'), date: document.getElementById('date'), addBtn: document.getElementById('addBtn'), clearBtn: document.getElementById('clearBtn'),
      table: document.querySelector('#txTable tbody'), balance: document.getElementById('balance'), income: document.getElementById('totalIncome'), expense: document.getElementById('totalExpense'), q: document.getElementById('q'), count: document.getElementById('count'), chart: document.getElementById('chart'), exportBtn: document.getElementById('exportBtn'), importBtn: document.getElementById('importBtn'), importFile: document.getElementById('importFile'), chips: document.getElementById('chips')
    }

    // populate categories select and chips
    function initCategories(){
      els.category.innerHTML=''; els.chips.innerHTML='';
      CATEGORIES.forEach(cat=>{
        const opt = document.createElement('option'); opt.value=cat.name; 
        opt.innerHTML = `<i class="${cat.icon}"></i> ${cat.name}`; 
        els.category.appendChild(opt);
        const chip = document.createElement('div'); 
        chip.className='chip'; 
        chip.innerHTML = `<i class="${cat.icon}"></i> ${cat.name}`; 
        chip.dataset.cat=cat.name; 
        chip.addEventListener('click', ()=>{ 
          document.getElementById('q').value = cat.name; 
          render(); 
          Array.from(document.querySelectorAll('.chip')).forEach(c=>c.classList.remove('active')); 
          chip.classList.add('active'); 
        }); 
        els.chips.appendChild(chip);
      });
    }

    function render(){
      updateAllCharts();
      const q = els.q.value.trim().toLowerCase();
      const rows = tx.filter(t=> !q || t.desc.toLowerCase().includes(q) || (t.category||'').toLowerCase().includes(q));
      els.table.innerHTML = '';
      let totalIncome=0, totalExpense=0;
      rows.slice().reverse().forEach(t=>{
        const tr = document.createElement('tr'); tr.className='row-anim';
        const category = CATEGORIES.find(c => c.name === t.category) || CATEGORIES[0];
        tr.innerHTML = `<td>${t.date}</td><td>${escapeHtml(t.desc)}</td><td><i class="${category.icon}"></i> ${escapeHtml(t.category)}</td><td class='amount ${t.type==='income'?'income':'expense'}'>${t.type==='income'?'+ ':'- '}${Number(t.amount).toFixed(2)} ₺</td><td><button data-id='${t.id}' data-action='edit' class='secondary'>Düzenle</button> <button data-id='${t.id}' class='secondary'>Sil</button></td>`;
        els.table.appendChild(tr);
        if(t.type==='income') totalIncome += Number(t.amount); else totalExpense += Number(t.amount);
      });
      const balance = totalIncome - totalExpense;
      els.balance.textContent = balance.toFixed(2) + ' ₺';
      els.income.textContent = totalIncome.toFixed(2) + ' ₺';
      els.expense.textContent = totalExpense.toFixed(2) + ' ₺';
      els.count.textContent = rows.length;
      // handlers: edit/delete
      Array.from(els.table.querySelectorAll('button')).forEach(b=> b.addEventListener('click', async (e)=>{
        const id = b.getAttribute('data-id'); 
        const action = b.getAttribute('data-action'); 
        if(action==='edit'){ 
          startEdit(id); 
        } else { 
          if(confirm('Silinsin mi?')){ 
            if(currentUser) {
              try {
                await db.collection('transactions').doc(id).delete();
              } catch(error) {
                console.error('Error deleting transaction:', error);
                alert('İşlem silinemedi: ' + error.message);
                return;
              }
            }
            tx = tx.filter(x=>x.id!==id); 
            if(!currentUser) save(); 
            render(); 
          } 
        }
      }));
      drawChart();
    }

    function escapeHtml(s){ return String(s||'').replace(/[&<>'"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]) }

    // add / update
    els.addBtn.addEventListener('click', async () => {
      const desc = els.desc.value.trim();
      const amount = Number(els.amount.value);
      const type = els.type.value;
      const category = els.category.value;
      const date = els.date.value || new Date().toISOString().slice(0,10);
      
      if(!desc || !amount || isNaN(amount)) { alert('Açıklama ve geçerli bir tutar girin.'); return; }
      if(editId){ // update
        if (currentUser) {
          try {
            await db.collection('transactions').doc(editId).update({
              desc, amount: Math.abs(amount), type, category, date, updated: Date.now()
            });
            const b = tx.find(x=>x.id===editId);
            if(b) {
              b.desc = desc;
              b.amount = Math.abs(amount);
              b.type = type;
              b.category = category;
              b.date = date;
              b.updated = Date.now();
            }
          } catch (error) {
            console.error('Error updating transaction:', error);
            alert('İşlem güncellenemedi: ' + error.message);
            return;
          }
        } else {
          const b = tx.find(x=>x.id===editId);
          if(b) {
            b.desc = desc;
            b.amount = Math.abs(amount);
            b.type = type;
            b.category = category;
            b.date = date;
            b.updated = Date.now();
          }
        }
        // Ses çal
        try {
          if(type === 'income') {
            playCoinSound('income');
            showToast('Para yatırıldı!', 'income');
          } else {
            playCoinSound('expense');
            showToast('Para çekildi!', 'expense');
          }
        } catch(err) {
          console.log('Ses çalınamadı:', err);
        }
        editId = null; els.addBtn.textContent='Ekle';
      } else {
        const item = {id: uid(), desc, amount: Math.abs(amount), type, category, date, updated: Date.now()};
        
        if (currentUser) {
          const savedItem = await saveTransaction(item);
          if (savedItem) {
            tx.push(savedItem);
          } else {
            alert('İşlem kaydedilemedi');
            return;
          }
        } else {
          tx.push(item);
        }
        
        // Ses çal ve toast göster
        try {
          if(type === 'income') {
            playCoinSound('income');
            showToast('Para yatırıldı!', 'income');
          } else {
            playCoinSound('expense');
            showToast('Para çekildi!', 'expense');
          }
        } catch(err) {
          console.log('Ses çalınamadı:', err);
        }
      }
      
      if (!currentUser) {
        save(); // Sadece yerel depolamada kaydet
      }
      render(); // Arayüzü güncelle
      els.desc.value=''; els.amount.value=''; els.date.value='';
      Array.from(document.querySelectorAll('.chip')).forEach(c=>c.classList.remove('active'));
    });

    function startEdit(id){ const b = tx.find(x=>x.id===id); if(!b) return; editId = id; els.desc.value = b.desc; els.amount.value = b.amount; els.type.value = b.type; els.category.value = b.category; els.date.value = b.date; els.addBtn.textContent='Güncelle'; window.scrollTo({top:0,behavior:'smooth'}); }

    els.clearBtn.addEventListener('click', ()=>{ els.desc.value=''; els.amount.value=''; els.date.value=''; els.type.value='expense'; els.category.value='Genel'; editId=null; els.addBtn.textContent='Ekle'; Array.from(document.querySelectorAll('.chip')).forEach(c=>c.classList.remove('active')); });
    els.q.addEventListener('input', ()=> render());

    // chart functions
    function drawChart(){
      if (!els.chart) return; // Eğer canvas elementi yoksa çizim yapma
      const ctx = els.chart.getContext('2d'); 
      const w = els.chart.width = els.chart.clientWidth; 
      const h = els.chart.height = 140; 
  ctx.clearRect(0,0,w,h);
  const styles = getComputedStyle(document.documentElement);
  const incomeColor = styles.getPropertyValue('--income').trim() || '#10b981';
  const expenseColor = styles.getPropertyValue('--expense').trim() || '#ef4444';
      
      const totals = {}; 
      tx.forEach(t=>{ 
        totals[t.category] = (totals[t.category]||0) + (t.type==='income'? Number(t.amount) : -Number(t.amount)) 
      });
      
      const entries = Object.entries(totals); 
      if(entries.length===0) return;
      
  const max = Math.max(1, ...entries.map(e=>Math.abs(e[1])));
      const barW = Math.floor(w / entries.length) - 16;
      
      entries.forEach((e,i)=>{
        const val = e[1]; 
        const x = i*(barW+16)+12; 
        const barH = Math.abs(val)/max * (h-50);
  ctx.fillStyle = val>=0 ? incomeColor : expenseColor;
        const y = val>=0 ? (h-30-barH) : (h-30);
        ctx.fillRect(x, y, barW, barH);
  ctx.fillStyle='#475569'; 
        ctx.font='12px Inter, sans-serif'; 
        const category = CATEGORIES.find(c => c.name === e[0]) || CATEGORIES[0];
        ctx.fillText(`${e[0]}`, x, h-8);
      });
    }

    function drawMonthlyChart(){
      const canvas = document.getElementById('monthlyChart');
      const ctx = canvas.getContext('2d');
      const w = canvas.width = canvas.clientWidth;
      const h = canvas.height;
      ctx.clearRect(0,0,w,h);

      // Son 12 ayın verilerini topla
      const monthlyData = {};
      const now = new Date();
      for(let i = 0; i < 12; i++) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const key = date.toISOString().slice(0,7);
        monthlyData[key] = {income: 0, expense: 0};
      }

      tx.forEach(t => {
        const month = t.date.slice(0,7);
        if(monthlyData[month]) {
          if(t.type === 'income') {
            monthlyData[month].income += Number(t.amount);
          } else {
            monthlyData[month].expense += Number(t.amount);
          }
        }
      });

      const months = Object.keys(monthlyData).sort();
  const maxAmount = Math.max(1, ...Object.values(monthlyData).flatMap(d => [d.income, d.expense]));
      const barW = Math.floor(w / months.length) - 16;

      months.forEach((month, i) => {
        const x = i * (barW + 16) + 12;
        const data = monthlyData[month];
        
  // Gelir barı
  const incomeH = (data.income / maxAmount) * (h - 80);
  const incomeColor = getComputedStyle(document.documentElement).getPropertyValue('--income').trim() || '#10b981';
  ctx.fillStyle = incomeColor;
  ctx.fillRect(x, h - 40 - incomeH, barW/2, incomeH);
        
  // Gider barı
  const expenseH = (data.expense / maxAmount) * (h - 80);
  const expenseColor = getComputedStyle(document.documentElement).getPropertyValue('--expense').trim() || '#ef4444';
  ctx.fillStyle = expenseColor;
  ctx.fillRect(x + barW/2, h - 40 - expenseH, barW/2, expenseH);
        
        // Ay etiketi
        ctx.fillStyle = '#475569';
        ctx.font = '12px Inter, sans-serif';
        const monthName = new Date(month).toLocaleString('tr', {month: 'short'});
        ctx.fillText(monthName, x, h - 10);

        // Değerler
        ctx.font = '10px Inter, sans-serif';
  ctx.fillStyle = incomeColor; ctx.fillText(`+${data.income.toFixed(0)}`, x, h - 45 - incomeH);
  ctx.fillStyle = expenseColor; ctx.fillText(`-${data.expense.toFixed(0)}`, x + barW/2, h - 45 - expenseH);
      });
    }

    function drawYearlyChart(){
      const canvas = document.getElementById('yearlyChart');
      const ctx = canvas.getContext('2d');
      const w = canvas.width = canvas.clientWidth;
      const h = canvas.height;
      ctx.clearRect(0,0,w,h);

      // Yıllık verileri topla
      const yearlyData = {};
      const now = new Date();
      for(let i = 0; i < 5; i++) {
        const year = now.getFullYear() - i;
        yearlyData[year] = {income: 0, expense: 0};
      }

      tx.forEach(t => {
        const year = t.date.slice(0,4);
        if(yearlyData[year]) {
          if(t.type === 'income') {
            yearlyData[year].income += Number(t.amount);
          } else {
            yearlyData[year].expense += Number(t.amount);
          }
        }
      });

      const years = Object.keys(yearlyData).sort();
  const maxAmount = Math.max(1, ...Object.values(yearlyData).flatMap(d => [d.income, d.expense]));
      const barW = Math.floor(w / years.length) - 24;

      years.forEach((year, i) => {
        const x = i * (barW + 24) + 24;
        const data = yearlyData[year];
        
  // Gelir barı
  const incomeH = (data.income / maxAmount) * (h - 80);
  const incomeColor = getComputedStyle(document.documentElement).getPropertyValue('--income').trim() || '#10b981';
  ctx.fillStyle = incomeColor;
  ctx.fillRect(x, h - 40 - incomeH, barW/2, incomeH);
        
  // Gider barı
  const expenseH = (data.expense / maxAmount) * (h - 80);
  const expenseColor = getComputedStyle(document.documentElement).getPropertyValue('--expense').trim() || '#ef4444';
  ctx.fillStyle = expenseColor;
  ctx.fillRect(x + barW/2, h - 40 - expenseH, barW/2, expenseH);
        
        // Yıl etiketi
        ctx.fillStyle = '#475569';
        ctx.font = '12px Inter, sans-serif';
        ctx.fillText(year, x, h - 10);

        // Net durum
        const net = data.income - data.expense;
        ctx.fillStyle = net >= 0 ? 'rgba(16,185,129,0.9)' : 'rgba(239,68,68,0.95)';
        ctx.font = '11px Inter, sans-serif';
        ctx.fillText(`${net >= 0 ? '+' : ''}${net.toFixed(0)}`, x, h - 25);
      });
    }

    // export/import
    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const data = JSON.stringify(tx, null, 2); 
      const blob = new Blob([data],{type:'application/json'}); 
      const url = URL.createObjectURL(blob); 
      const a = document.createElement('a'); 
      a.href = url; 
      a.download = 'transactions.json'; 
      document.body.appendChild(a); 
      a.click(); 
      a.remove(); 
      setTimeout(()=>URL.revokeObjectURL(url), 2000);
    });

    document.getElementById('importBtn').addEventListener('click', ()=> {
      if(!currentUser) {
        document.getElementById('importFile').click();
      } else {
        alert('Google hesabıyla giriş yapmışken içe aktarma yapamazsınız. Verileriniz otomatik olarak kaydedilmektedir.');
      }
    });

    document.getElementById('importFile').addEventListener('change', async (e)=>{
      const f = e.target.files[0]; 
      if(!f) return; 
      const reader = new FileReader(); 
      reader.onload = async ()=>{
        try{ 
          const data = JSON.parse(reader.result); 
          if(Array.isArray(data)){ 
            const newTransactions = data.map(d=>({
              id: uid(), 
              desc: d.desc||d.description||'', 
              amount: Math.abs(Number(d.amount||0)), 
              type: d.type||'expense', 
              category: d.category||'Genel', 
              date: d.date||new Date().toISOString().slice(0,10)
            }));

            if(!currentUser) {
              tx = tx.concat(newTransactions);
              save();
              render();
              alert('İçe aktarma tamamlandı.');
            } else {
              try {
                // Firebase'e toplu ekleme
                const batch = db.batch();
                newTransactions.forEach(t => {
                  const ref = db.collection('transactions').doc();
                  batch.set(ref, {...t, userId: currentUser.uid});
                });
                await batch.commit();
                await loadUserTransactions();
                alert('İçe aktarma tamamlandı.');
              } catch(error) {
                console.error('Error importing transactions:', error);
                alert('İçe aktarma başarısız: ' + error.message);
              }
            }
          } else {
            alert('Dosya formatı beklenen JSON değil.');
          }
        } catch(err){ 
          alert('İçe aktarma başarısız: '+err.message); 
        }
      }; 
      reader.readAsText(f);
    });

    // init
    initCategories(); 
    load(); 
    // load theme before first render so charts pick up correct colors
    loadTheme();
    render(); 
    
    // Tüm grafikleri güncelle
    function updateAllCharts() {
      if (els.chart) {
        drawChart();
      }
    }
    
    window.addEventListener('resize', updateAllCharts);
    els.addBtn.addEventListener('click', updateAllCharts);
    els.clearBtn.addEventListener('click', updateAllCharts);
    // theme toggle wiring
    const themeBtn = document.getElementById('themeToggle');
    if(themeBtn) themeBtn.addEventListener('click', toggleTheme);
  </script>
</body>
</html>